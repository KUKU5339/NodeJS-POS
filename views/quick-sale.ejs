<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Sale - StreetPOS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f4f5f7;color:#333}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#800000;color:#fff}
    .brand{font-weight:800}
    .topbar nav a{color:#fff;margin-left:16px;text-decoration:none}
    .layout{display:flex;min-height:calc(100vh - 48px)}
    .sidebar{width:240px;background:#fff;border-right:1px solid #e5e7eb}
    .sidebar .title{padding:14px 16px;font-weight:700;color:#800000}
    .menu a{display:flex;align-items:center;gap:10px;padding:12px 16px;color:#333;text-decoration:none;border-left:4px solid transparent}
    .menu a.active{background:#fff7e6;border-left-color:#FFD700}
    .menu a:hover{background:#f8f9fa}
    .content{flex:1;padding:24px}
    h1{font-size:22px;color:#800000;margin:6px 0 20px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .product{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;cursor:pointer;display:flex;gap:10px;align-items:center}
    .img{width:52px;height:52px;border-radius:10px;object-fit:cover;border:1px solid #eee;background:#f8f9fa;display:flex;align-items:center;justify-content:center}
    .product:hover{box-shadow:0 2px 8px rgba(0,0,0,0.06)}
    .panel{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px;margin-top:16px}
    .input{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px}
    .btn{background:#800000;color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .empty-state{text-align:center;padding:40px;color:#999}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">StreetPOS</div>
    <nav>
      <a href="/dashboard">Dashboard</a>
      <a href="#" id="logout">Logout</a>
    </nav>
  </div>
  <div class="layout">
    <aside class="sidebar">
      <div class="title">StreetPOS</div>
      <nav class="menu">
        <a href="/dashboard"><i class="fas fa-gauge"></i><span>Dashboard</span></a>
        <a href="/products"><i class="fas fa-boxes"></i><span>Products</span></a>
        <a class="active" href="/quick-sale"><i class="fas fa-bolt"></i><span>Quick Sale</span></a>
        <a href="/sales"><i class="fas fa-receipt"></i><span>Sales History</span></a>
        <a href="/profit"><i class="fas fa-calculator"></i><span>Profit Calculator</span></a>
        <a href="/stock-alerts"><i class="fas fa-bell"></i><span>Stock Alerts</span></a>
        <a href="/reports"><i class="fas fa-chart-line"></i><span>Sales Report</span></a>
      </nav>
    </aside>
    <main class="content">
      <h1>Quick Sale</h1>
      <div id="productsGrid" class="grid"></div>
      <div class="panel" id="salePanel" style="display:none">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
          <div id="selImg" class="img">üç¢</div>
          <div>
            <div id="selName" style="font-weight:700"></div>
            <div id="selPrice" style="color:#6b7280"></div>
            <div id="selStock" style="color:#6b7280"></div>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <label>Quantity</label>
            <input id="quantity" type="number" class="input" min="1" value="1">
          </div>
          <div style="flex:1">
            <label>Total</label>
            <input id="total" class="input" readonly>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="confirm" class="btn">Confirm Sale</button>
          <button id="cancel" class="btn secondary">Cancel</button>
          <div id="msg" style="color:#16a34a;font-weight:600;display:none">Sale recorded!</div>
          <div id="err" style="color:#dc2626;font-weight:600;display:none">Error</div>
        </div>
      </div>
    </main>
  </div>
  <script src="/app.js"></script>
  <script>
    let selected = null;
    function fmt(n){return '‚Ç±' + Number(n||0).toFixed(2)}
    function renderProducts(items){
      const grid = document.getElementById('productsGrid');
      if (!items || items.length === 0) {
        grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No products in stock</div>';
        return;
      }
      grid.innerHTML = items.map(p => (
        '<div class="product" data-id="'+p.id+'" data-price="'+p.price+'" data-stock="'+p.stock+'" data-image="'+(p.image_url||'')+'" data-name="'+p.name+'">' +
          (p.image_url ? '<img class="img" src="'+p.image_url+'"/>' : '<div class="img">üç¢</div>') +
          '<div><div style="font-weight:700">'+p.name+'</div><div style="color:#6b7280">'+fmt(p.price)+' ‚Ä¢ Stock '+p.stock+'</div></div>' +
        '</div>'
      )).join('');
      grid.querySelectorAll('.product').forEach(el => {
        el.addEventListener('click', () => {
          const p = {
            id: Number(el.dataset.id),
            name: el.dataset.name,
            price: Number(el.dataset.price),
            stock: Number(el.dataset.stock),
            image_url: el.dataset.image
          };
          selected = p;
          document.getElementById('salePanel').style.display = '';
          document.getElementById('selName').textContent = p.name;
          document.getElementById('selPrice').textContent = 'Price: ' + fmt(p.price);
          document.getElementById('selStock').textContent = 'In stock: ' + p.stock;
          const img = document.getElementById('selImg');
          if (p.image_url) { img.innerHTML = '<img class="img" src="'+p.image_url+'"/>'; } else { img.textContent = 'üç¢'; }
          document.getElementById('quantity').value = '1';
          document.getElementById('total').value = fmt(p.price * 1);
        });
      });
    }
    async function load(){
      const data = await window.apiGet('/api/products/in-stock');
      renderProducts(data ? data.products : []);
    }
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('logout').addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('nodepos_token');
        window.location.href = '/';
      });
      load();
      document.getElementById('cancel').addEventListener('click', () => {
        document.getElementById('salePanel').style.display = 'none';
        selected = null;
      });
      document.getElementById('quantity').addEventListener('input', (e) => {
        const q = Math.max(1, Number(e.target.value || 1));
        e.target.value = String(q);
        if (selected) document.getElementById('total').value = fmt(selected.price * q);
      });
      document.getElementById('confirm').addEventListener('click', async () => {
        const msg = document.getElementById('msg'); const err = document.getElementById('err');
        msg.style.display = 'none'; err.style.display = 'none';
        try {
          if (!selected) return;
          const qty = Number(document.getElementById('quantity').value || 1);
          const token = window.getToken();
          const res = await fetch('/api/sales', {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': 'Bearer ' + token } : {}),
            body: JSON.stringify({ product_id: selected.id, quantity: qty })
          });
          if (!res.ok) throw new Error('bad');
          await res.json();
          msg.style.display = '';
          document.getElementById('salePanel').style.display = 'none';
          selected = null;
          load();
        } catch {
          err.style.display = '';
        }
      });
    });
  </script>
</body>
</html>
